#!/bin/bash

run_folder="$PWD"

# Create a time stamp, in order to backup PLANTS output if it already exists
datetime=$(date "+%Y%m%d%H%M%S")

# Start up
source $CHEMFLOW_HOME/DockFlow/DockFlow_interface.bash
source $CHEMFLOW_HOME/DockFlow/DockFlow_functions.bash
source $CHEMFLOW_HOME/common/check_mazinger_status.bash
source $CHEMFLOW_HOME/common/ProgressBar.bash

# Welcome user
welcome

# Source ChemFlow config file for paths
source $CHEMFLOW_HOME/ChemFlow.config

# User interface
DF_CLI "$@"

# Write user parameters to a temporary file
declare -p | awk '/declare --/ {print $3}' | awk 'f;/^_.*$/{f=1}' | grep -Fv -e "^_" -e "_list" > temp.config

# if config file specified using the -f flag
if [ ! -z "$CONFIG_FILE" ]; then
  echo "Reading configuration from $CONFIG_FILE"
  source "$CONFIG_FILE"
else
# if a config file was not specified
  # if a config file exists in the current directory
  if [ -f DockFlow.config ]; then
    # Use this one instead
    source DockFlow.config
  # if no config file was specified and doesn't exist in the current directory
  else
    echo "${RED}FATAL ERROR${NC} : No configuration file found for DockFlow"
    usage
    exit 1
  fi
fi
# Overwrite parameters in config files with user parameters
write_DF_config

# Prepare folders and input file to run
prepare_docking

# Run plants with the options
run_plants

# copy config file to output folder
cp ${run_folder}/DockFlow.config ${run_folder}/docking/

# If running on mazinger, wait untill all jobs are finished
if [ ${run_mode} = "mazinger" ]; then mazinger_progress_bar ${run_folder}/docking/jobs_list_${datetime}.mazinger; fi

# If some results are missing, count how many and output it
if [ -f docking/errors.csv ]; then
  errorcount=$(cat docking/errors.csv | wc -l)
  echo -e "${RED}ERRORS detected${NC} : ${errorcount}"
  echo "See docking/errors.csv for more info"
fi

# exit
exit_message
