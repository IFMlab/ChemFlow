#!/bin/bash

#####################################################################
#   ChemFlow  -   Computational Chemistry is great again            #
#####################################################################
#
# Diego E. B. Gomes(1,2,3) - dgomes@pq.cnpq.br
# Cedric Bouysset (3,4) - cbouysset@unice.fr
# Marco Cecchini (3) - cecchini@unistra.fr
#
# 1 - Instituto Nacional de Metrologia, Qualidade e Tecnologia - Brazil
# 2 - Coordenacao Aperfeicoamento de Pessoal de Ensino Superior - CAPES - Brazil.
# 3 - Universite de Strasbourg - France
# 4 - Universite de Nice - France
#
#===============================================================================
#
#          FILE:  DockFlow.bash
#
#         USAGE: ./DockFlow.bash -p myproject -r receptor.mol2 -l multilig.mol2 --center 2.2 -4.5 0.75 [-j SLURM] ..
#
#
#         BRIEF: Main routine for DockFlow
#   DESCRIPTION: Prepare and run a docking calculation.
#    COMPLIANCY: The ChemFlow standard version 1.0
#
#     MANDATORY:  -r receptor.mol2 -l ligand.mol2 -p myproject --center X Y Z
#  MAIN OPTIONS: [-protocol default] [-nc 8] [-sf chemplp] [--radius 15]
#  REQUIREMENTS:  PLANTS or VINA, [SLURM, PBS]
#          BUGS:  ---
#         NOTES:  ---
#        AUTHOR:  Diego E. B. Gomes, dgomes@pq.cnpq.br
#       COMPANY:  Universite de Strasbourg / CAPES
#       VERSION:  1.0
#       CREATED:  lundi 28 mai 2018, 16:05:06 (UTC+0200)
#      REVISION:  ---
#===============================================================================
if [ -z ${CHEMFLOW_HOME} ] ; then
  echo "CHEMFLOW_HOME is not defined"
  exit 0
fi

echo "
########################################################################
#        ChemFlow  -   Computational Chemistry is great again          #
########################################################################
#                                                                      #
#   +++++++++++++++++++                                                #
#   + Universit√© ||| |+                                                #
#   +++++++++++++++++++++++                                            #
#       + ||de Strasbourg +                                            #
#       +++++++++++++++++++                                            #
#                                                                      #
#                                                                      #
# Diego E. B. Gomes - dgomes@pq.cnpq.br                                #
# Cedric Bouysset - cbouysset@unice.fr                                   #
# Marco Cecchini - cecchini@unistra.fr                                 #
# Donatienne de Francquen - donatienne.de-francquen@etu.unistra.fr     #
########################################################################"

# Read out functions
source ${CHEMFLOW_HOME}/src/DockFlow_functions.bash
source ${CHEMFLOW_HOME}/src/ChemFlow_functions.bash
ChemFlow_set_defaults 'DockFlow'   # Set default values for docking parameters.
DockFlow_CLI "$@"        # Read the command line.
ChemFlow_validate_input  # Sanity check. (parameters and input files)

RUNDIR=${WORKDIR}/${PROJECT}.chemflow/DockFlow/${PROTOCOL}/${RECEPTOR_NAME}/

if [ ! -z ${ARCHIVE} ] ; then
    DockFlow_archive
elif  [ ! -z ${POSTPROCESS} ] ; then
    DockFlow_postdock       # Standardizes the output
else
    DockFlow_summary        # Show a summary of actions.
    DockFlow_prepare_input  # Organizes and convert required files
    DockFlow_dock           # Runs the docking
fi

#DockFlow_Report
echo "
[ DockFlow ] Normal completion.
"
