#!/bin/bash

##################################################################### 
#   ChemFlow  -   Computational Chemistry is great again            #
#####################################################################
#
# Diego E. B. Gomes(1,2,3) - dgomes@pq.cnpq.br
# Cedric Boysset (3,4) - cboysset@unice.fr
# Marco Cecchini (3) - cecchini@unistra.fr
#
# 1 - Instituto Nacional de Metrologia, Qualidade e Tecnologia - Brazil
# 2 - Coordenacao Aperfeicoamento de Pessoal de Ensino Superior - CAPES - Brazil.
# 3 - Universite de Strasbourg - France
# 4 - Universite de Nice - France
#
#===============================================================================
#
#          FILE:  ScoreFlow2.bash
#
#         USAGE: ./ScoreFlow2.bash -p myproject -r receptor.mol2 -l multilig.mol2 -sf chemplp [-w SLURM]...
# 
#
#         BRIEF: Main routine for ScoreFlow
#   DESCRIPTION: Prepare and run a rescoring calculation.
#    COMPLIANCY: The ChemFlow standard version 1.0
#
#     MANDATORY:  -r receptor.mol2 -l ligand.mol2 -p myproject
#GBSA MANDATORY:  -pdb receptor.pdb -l ligand.mol2 -p myproject
#  MAIN OPTIONS: [-protocol default] [-nc 8] [-sf chemplp] [--radius 15] 
#  REQUIREMENTS:  PLANTS or VINA, [SLURM, PBS]
#          BUGS:  ---
#         NOTES:  ---
#        AUTHOR:  Diego E. B. Gomes, dgomes@pq.cnpq.br
#       COMPANY:  Universite de Strasbourg / CAPES
#       VERSION:  1.0
#       CREATED:  mardi 29 mai 2018, 15:49:45 (UTC+0200)
#      REVISION:  ---
#===============================================================================

if [ -z ${CHEMFLOW_HOME} ] ; then 
  echo "CHEMFLOW_HOME is not defined"
  exit 0
fi


# Corrigir o nome do receptor quando usar o PDB
# Corrigir o SPLIT pois uso o echo " >> "
# [project].chemflow/[action]/[protocol]/[target]/[query].

# Read out functions
source ${CHEMFLOW_HOME}/src/ScoreFlow_functions.bash
source ${CHEMFLOW_HOME}/src/ChemFlow_functions.bash

ChemFlow_set_defaults 'ScoreFlow'  # Set default values for docking parameters.
ScoreFlow_CLI "$@"       # Read the command line.
ChemFlow_validate_input  # Various Checks
RUNDIR=${WORKDIR}/${PROJECT}.chemflow/ScoreFlow/${PROTOCOL}/${RECEPTOR_NAME}/

if [ ! -z ${POSTPROCESS} ] ; then
    ScoreFlow_postprocess
else
    ScoreFlow_summary        # User Validation
    ScoreFlow_organize       # Organize to ChemFlow Standard
    ScoreFlow_rescore        # Run the rescoring.
fi

echo "
[ ScoreFlow ] Normal completion.
"
